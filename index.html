<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Zoey's Tree Hole</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 500px; margin: 40px auto; padding: 0 20px; background: #f0f2f5; }
  h2 { text-align: center; color: #333; }
  #login, #chat { display: none; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  #messages { border: 1px solid #ddd; border-radius: 10px; padding: 10px; height: 350px; overflow-y: auto; background: #fafafa; margin-bottom: 10px; }
  .msg { margin: 6px 0; padding: 8px 12px; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
  .msg.self { background-color: #4a90e2; color: #fff; margin-left: auto; text-align: right; }
  .msg.other { background-color: #e2e2e2; color: #333; margin-right: auto; }
  input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; margin-top: 10px; font-size: 14px; }
  button { width: 100%; padding: 10px; border-radius: 8px; border: none; font-size: 16px; margin-top: 10px; cursor: pointer; transition: background 0.3s; }
  button:hover { opacity: 0.9; }
  .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
  .time { font-size: 10px; color: #999; margin-top: 2px; }
  .recording { background-color: red; }
  #sendBtn,#sendImgBtn,#recordBtn{background:#4a90e2;color:#fff;}
  #clearBtn{background:red;color:#fff;}
  #scrollBtn,#newMsgBtn{background:#4CAF50;color:#fff;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2>Zoey's Tree Hole</h2>

<div id="login">
  <input id="pwd" type="password" placeholder="è¾“å…¥å¯†ç ...">
  <button id="enterBtn">è¿›å…¥èŠå¤©å®¤</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <input id="name" placeholder="ä½ çš„æ˜µç§°">
  <textarea id="text" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
  <input type="file" id="imgFile" accept="image/*">
  <button id="sendBtn">å‘é€æ–‡å­—</button>
  <button id="sendImgBtn">å‘é€å›¾ç‰‡</button>
  <button id="recordBtn">ğŸ¤ å¼€å§‹å½•éŸ³</button>
  <button id="clearBtn">æ¸…ç©ºèŠå¤©è®°å½•</button>
  <button id="scrollBtn">æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯</button>
  <button id="newMsgBtn" style="display:none;">æœ‰æ–°æ¶ˆæ¯ï¼Œç‚¹å‡»æ»šåˆ°åº•éƒ¨</button>
</div>

<script>
// ===== ç™»å½• =====
const correctPwd = "1116";
const loginDiv = document.getElementById('login');
const chatDiv = document.getElementById('chat');
loginDiv.style.display = 'block';
document.getElementById('enterBtn').onclick = ()=>{
  if(document.getElementById('pwd').value===correctPwd){
    loginDiv.style.display='none';
    chatDiv.style.display='block';
    initChat();
  } else alert('å¯†ç é”™è¯¯ï¼');
};

// ===== Firebase åˆå§‹åŒ– =====
const firebaseConfig = {
  apiKey: "AIzaSyDRRfTxolkcKcbMAmACt6IWkgkQggDoR_k",
  authDomain: "zoey-58d4f.firebaseapp.com",
  databaseURL: "https://zoey-58d4f-default-rtdb.firebaseio.com",
  projectId: "zoey-58d4f",
  storageBucket: "zoey-58d4f.appspot.com",
  messagingSenderId: "127750946450",
  appId: "1:127750946450:web:30067ce25445c13bc4b04b",
  measurementId: "G-CVRRFN38ZM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const roomRef = db.ref('zoey-tree-hole');
const messagesDiv = document.getElementById('messages');
let currentUser = "";
let pageSize = 20;
let firstMessageKey = null;
let loadingHistory = false;

// ===== å·¥å…·å‡½æ•° =====
function formatTimeSafe(ts){ try{return new Date(ts).toLocaleString();}catch(e){return "æ—¶é—´æœªçŸ¥";} }
function addMessageSafe(msg, prepend=false){
  if(!msg) return;
  const div = document.createElement('div');
  div.className = 'msg '+(msg.name===currentUser?'self':'other');
  const name = msg.name||"åŒ¿å";
  const text = msg.text||"";
  const imageUrl = msg.imageUrl||"";
  const audioUrl = msg.audioUrl||"";
  let timestamp = msg.timestamp; if(!timestamp||typeof timestamp!=='number') timestamp=Date.now();
  let html=`<strong>${name}</strong><br>`;
  if(text) html+=text+'<br>';
  if(imageUrl) html+=`<img src="${imageUrl}" class="chat-img"><br>`;
  if(audioUrl) html+=`<audio controls src="data:audio/webm;base64,${audioUrl}"></audio><br>`;
  html+=`<div class="time">${formatTimeSafe(timestamp)}</div>`;
  div.innerHTML=html;
  if(prepend) messagesDiv.insertBefore(div, messagesDiv.firstChild);
  else messagesDiv.appendChild(div);
}

// ===== æ»šåŠ¨å¤„ç† =====
const scrollBtn = document.getElementById('scrollBtn');
const newMsgBtn = document.getElementById('newMsgBtn');
function scrollToBottom(){ messagesDiv.scrollTop = messagesDiv.scrollHeight; }
scrollBtn.onclick = scrollToBottom;

let isAtBottom = true;
messagesDiv.addEventListener('scroll', ()=>{
  const threshold = 20;
  isAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight <= threshold;
  if(isAtBottom) newMsgBtn.style.display = 'none';
});

// ===== åˆ†é¡µåŠ è½½å†å² =====
function loadLatestMessages(){
  roomRef.orderByChild('timestamp').limitToLast(pageSize).once('value', snapshot=>{
    const msgs = [];
    snapshot.forEach(snap=>{ msgs.push({...snap.val(), key:snap.key}); });
    msgs.sort((a,b)=>a.timestamp-b.timestamp);
    if(msgs.length>0) firstMessageKey = msgs[0].key;
    msgs.forEach(msg => addMessageSafe(msg));
    scrollToBottom();
  });
}

messagesDiv.addEventListener('scroll', ()=>{
  if(messagesDiv.scrollTop === 0 && !loadingHistory && firstMessageKey){
    loadingHistory = true;
    roomRef.orderByKey().endBefore(firstMessageKey).limitToLast(pageSize).once('value', snapshot=>{
      const msgs = [];
      snapshot.forEach(snap=>msgs.push({...snap.val(), key:snap.key}));
      if(msgs.length>0){
        firstMessageKey = msgs[0].key;
        msgs.sort((a,b)=>a.timestamp-b.timestamp);
        const scrollHeightBefore = messagesDiv.scrollHeight;
        msgs.forEach(msg => addMessageSafe(msg, true));
        messagesDiv.scrollTop = messagesDiv.scrollHeight - scrollHeightBefore;
      }
      loadingHistory = false;
    });
  }
});

// ===== æ–°æ¶ˆæ¯å¤„ç† =====
function handleNewMessage(msg){
  addMessageSafe(msg);
  if(isAtBottom) scrollToBottom();
  else newMsgBtn.style.display='block';
}
newMsgBtn.onclick = ()=>{
  scrollToBottom();
  newMsgBtn.style.display='none';
};

// ===== åˆå§‹åŒ–èŠå¤© =====
function initChat(){
  loadLatestMessages();
  // å®æ—¶ç›‘å¬æ–°æ¶ˆæ¯
  roomRef.on('child_added', snap=>{
    handleNewMessage(snap.val());
  });
}

// ===== å‘é€æ–‡å­— =====
document.getElementById('sendBtn').onclick=()=>{
  const name=document.getElementById('name').value.trim();
  const text=document.getElementById('text').value.trim();
  if(!name||!text) return;
  currentUser=name;
  roomRef.push({name,name,text:text||null,imageUrl:null,audioUrl:null,timestamp:Date.now()});
  document.getElementById('text').value='';
};

// ===== å‘é€å›¾ç‰‡ =====
document.getElementById('sendImgBtn').onclick=async ()=>{
  const file=document.getElementById('imgFile').files[0];
  const name=document.getElementById('name').value.trim();
  if(!file||!name) return alert("è¯·é€‰æ‹©å›¾ç‰‡å¹¶è¾“å…¥æ˜µç§°");
  currentUser=name;
  const formData=new FormData();
  formData.append("file",file);
  formData.append("upload_preset","zoey111");
  const btn=document.getElementById('sendImgBtn'); btn.disabled=true;
  try{
    const xhr=new XMLHttpRequest();
    xhr.open("POST","https://api.cloudinary.com/v1_1/dumxyqnin/image/upload");
    xhr.upload.onprogress=e=>{
      if(e.lengthComputable){ btn.textContent=`ä¸Šä¼ ä¸­...(${Math.round(e.loaded/e.total*100)}%)`; }
    };
    xhr.onload=()=>{
      const data=JSON.parse(xhr.responseText);
      roomRef.push({name,name,text:null,imageUrl:data.secure_url||null,audioUrl:null,timestamp:Date.now()});
      document.getElementById('imgFile').value=''; btn.textContent="å‘é€å›¾ç‰‡"; btn.disabled=false;
    };
    xhr.onerror=()=>{ alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥"); btn.textContent="å‘é€å›¾ç‰‡"; btn.disabled=false; };
    xhr.send(formData);
  }catch(e){ console.warn("å›¾ç‰‡ä¸Šä¼ å¼‚å¸¸",e); btn.textContent="å‘é€å›¾ç‰‡"; btn.disabled=false; }
};

// ===== å½•éŸ³ =====
let recorder,audioChunks=[],isRecording=false,recordInterval;
document.getElementById('recordBtn').onclick=async ()=>{
  const btn=document.getElementById('recordBtn');
  const name=document.getElementById('name').value.trim();
  if(!name) return alert("è¯·è¾“å…¥æ˜µç§°");
  currentUser=name;
  if(!isRecording){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      recorder=new MediaRecorder(stream); audioChunks=[];
      recorder.ondataavailable=e=>audioChunks.push(e.data);
      let seconds=0; recordInterval=setInterval(()=>{seconds++; btn.textContent=`å½•éŸ³ä¸­ ${seconds}s â¹`;},1000);
      recorder.onstop=()=>{
        clearInterval(recordInterval);
        const blob=new Blob(audioChunks,{type:'audio/webm'}); audioChunks=[];
        const reader=new FileReader();
        reader.onloadend=()=>{ roomRef.push({name,name,text:null,imageUrl:null,audioUrl:reader.result.split(',')[1],timestamp:Date.now()}); };
        reader.readAsDataURL(blob);
        btn.textContent="ğŸ¤ å¼€å§‹å½•éŸ³"; btn.classList.remove("recording"); isRecording=false;
      };
      recorder.start(); btn.classList.add("recording"); isRecording=true;
    }catch(err){ alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼š"+err); }
  }else{ recorder.stop(); }
};

// ===== æ¸…ç©º =====
document.getElementById('clearBtn').onclick=()=>{
  if(confirm("ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ")){
    roomRef.remove(); messagesDiv.innerHTML='';
  }
};
</script>
</body>
</html>
