<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Zoey's Tree Hole</title>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 500px; margin: 40px auto; padding: 0 20px; background: #f0f2f5; }
  h2 { text-align: center; color: #333; }
  #login, #chat { display: none; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  #messages { border: 1px solid #ddd; border-radius: 10px; padding: 10px; height: 350px; overflow-y: auto; background: #fafafa; margin-bottom: 10px; }
  .msg { margin: 6px 0; padding: 8px 12px; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
  .msg.self { background-color: #4a90e2; color: #fff; margin-left: auto; text-align: right; }
  .msg.other { background-color: #e2e2e2; color: #333; margin-right: auto; }
  input, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; margin-top: 10px; font-size: 14px; }
  button { width: 100%; padding: 10px; border-radius: 8px; border: none; background-color: #4a90e2; color: #fff; font-size: 16px; margin-top: 10px; cursor: pointer; transition: background 0.3s; }
  button:hover { background-color: #357abd; }
  .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
  .time { font-size: 10px; color: #999; margin-top: 2px; }
  .recording { background-color: red; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h2>Zoey's Tree Hole</h2>

<div id="login">
  <input id="pwd" type="password" placeholder="è¾“å…¥å¯†ç ...">
  <button id="enterBtn">è¿›å…¥èŠå¤©å®¤</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <input id="name" placeholder="ä½ çš„æ˜µç§°">
  <textarea id="text" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
  <input type="file" id="imgFile" accept="image/*">
  <button id="sendBtn">å‘é€æ–‡å­—</button>
  <button id="sendImgBtn">å‘é€å›¾ç‰‡</button>
  <button id="recordBtn">ğŸ¤ å¼€å§‹å½•éŸ³</button>
  <button id="clearBtn" style="background:red;">æ¸…ç©ºèŠå¤©è®°å½•</button>
</div>

<script>
// ===== ç™»å½•éªŒè¯ =====
const correctPwd = "1116";
const loginDiv = document.getElementById('login');
const chatDiv = document.getElementById('chat');
loginDiv.style.display = 'block';
document.getElementById('enterBtn').onclick = () => {
  if(document.getElementById('pwd').value === correctPwd){
    loginDiv.style.display = 'none';
    chatDiv.style.display = 'block';
    loadLatestMessages(); // ç™»å½•æˆåŠŸååŠ è½½æœ€è¿‘æ¶ˆæ¯
  }else{
    alert('å¯†ç é”™è¯¯ï¼');
  }
};

// ===== Firebase é…ç½® =====
const firebaseConfig = {
  apiKey: "AIzaSyDRRfTxolkcKcbMAmACt6IWkgkQggDoR_k",
  authDomain: "zoey-58d4f.firebaseapp.com",
  databaseURL: "https://zoey-58d4f-default-rtdb.firebaseio.com",
  projectId: "zoey-58d4f",
  storageBucket: "zoey-58d4f.appspot.com",
  messagingSenderId: "127750946450",
  appId: "1:127750946450:web:30067ce25445c13bc4b04b",
  measurementId: "G-CVRRFN38ZM"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const roomRef = db.ref('zoey-tree-hole');
const messagesDiv = document.getElementById('messages');
let currentUser = "";

// ===== å·¥å…·å‡½æ•° =====
function formatTime(timestamp){
  const date = new Date(timestamp);
  return date.toLocaleString();
}

function addMessage(msg, prepend=false){
  const div = document.createElement('div');
  div.className = 'msg ' + (msg.name===currentUser?'self':'other');
  let html = `<strong>${msg.name}</strong><br>`;
  if(msg.text) html += msg.text + '<br>';
  if(msg.imageUrl) html += `<img src="${msg.imageUrl}" class="chat-img"><br>`;
  if(msg.audioUrl) html += `<audio controls src="data:audio/webm;base64,${msg.audioUrl}"></audio><br>`;
  html += `<div class="time">${formatTime(msg.timestamp)}</div>`;
  div.innerHTML = html;
  if(prepend) messagesDiv.insertBefore(div, messagesDiv.firstChild);
  else messagesDiv.appendChild(div);
}

// ===== åˆ†é¡µåŠ è½½è®¾ç½® =====
let pageSize = 20;
let firstMessageKey = null;
let loadingHistory = false;

// åˆå§‹åŠ è½½æœ€æ–°æ¶ˆæ¯
function loadLatestMessages() {
  roomRef.orderByChild('timestamp').limitToLast(pageSize).once('value', snapshot => {
    const msgs = [];
    snapshot.forEach(snap => msgs.push({...snap.val(), key: snap.key}));
    msgs.sort((a,b)=>a.timestamp-b.timestamp);
    if(msgs.length>0) firstMessageKey = msgs[0].key;
    msgs.forEach(msg => addMessage(msg));
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// æ»šåŠ¨åŠ è½½å†å²æ¶ˆæ¯
messagesDiv.addEventListener('scroll', ()=>{
  if(messagesDiv.scrollTop === 0 && !loadingHistory && firstMessageKey) {
    loadingHistory = true;
    roomRef.orderByKey().endBefore(firstMessageKey).limitToLast(pageSize).once('value', snapshot=>{
      const msgs=[];
      snapshot.forEach(snap=>msgs.push({...snap.val(), key:snap.key}));
      if(msgs.length>0){
        firstMessageKey = msgs[0].key;
        msgs.sort((a,b)=>a.timestamp-b.timestamp);
        const scrollHeightBefore = messagesDiv.scrollHeight;
        msgs.forEach(msg => addMessage(msg,true));
        messagesDiv.scrollTop = messagesDiv.scrollHeight - scrollHeightBefore;
      }
      loadingHistory=false;
    });
  }
});

// ===== ç›‘å¬å®æ—¶æ–°æ¶ˆæ¯ =====
roomRef.orderByChild('timestamp').startAt(Date.now()).on('child_added', snap=>{
  const msg = snap.val();
  if(!msg) return;
  addMessage(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// ===== å‘é€æ–‡å­— =====
function sendText(){
  const name = document.getElementById('name').value.trim();
  const text = document.getElementById('text').value.trim();
  if(!name || !text) return;
  currentUser = name;
  roomRef.push({
    name: name,
    text: text || null,
    imageUrl: null,
    audioUrl: null,
    timestamp: Date.now()
  });
  document.getElementById('text').value = '';
}
document.getElementById('sendBtn').onclick = sendText;

// ===== å‘é€å›¾ç‰‡ =====
document.getElementById('sendImgBtn').onclick = async ()=>{
  const file = document.getElementById('imgFile').files[0];
  const name = document.getElementById('name').value.trim();
  if(!file || !name) return alert("è¯·é€‰æ‹©å›¾ç‰‡å¹¶è¾“å…¥æ˜µç§°");
  currentUser = name;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "zoey111");
  const btn = document.getElementById('sendImgBtn');
  btn.disabled = true;
  try{
    const xhr = new XMLHttpRequest();
    xhr.open("POST","https://api.cloudinary.com/v1_1/dumxyqnin/image/upload");
    xhr.upload.onprogress = e=>{
      if(e.lengthComputable){
        const percent = Math.round((e.loaded/e.total)*100);
        btn.textContent = `ä¸Šä¼ ä¸­...(${percent}%)`;
      }
    };
    xhr.onload = ()=>{
      const data = JSON.parse(xhr.responseText);
      const imageUrl = data.secure_url;
      roomRef.push({
        name: name,
        text: null,
        imageUrl: imageUrl || null,
        audioUrl: null,
        timestamp: Date.now()
      });
      document.getElementById('imgFile').value = '';
      btn.textContent = "å‘é€å›¾ç‰‡";
      btn.disabled = false;
    };
    xhr.onerror = ()=>{
      alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Cloudinary é…ç½®");
      btn.textContent = "å‘é€å›¾ç‰‡";
      btn.disabled = false;
    };
    xhr.send(formData);
  }catch(err){
    console.error(err);
    alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥");
    btn.textContent = "å‘é€å›¾ç‰‡";
    btn.disabled = false;
  }
};

// ===== å½•éŸ³å‘é€ =====
let recorder,audioChunks=[],isRecording=false,recordInterval;
document.getElementById('recordBtn').onclick = async ()=>{
  const btn = document.getElementById('recordBtn');
  const name = document.getElementById('name').value.trim();
  if(!name) return alert("è¯·è¾“å…¥æ˜µç§°");
  if(!isRecording){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e=>audioChunks.push(e.data);
      let seconds = 0;
      recordInterval = setInterval(()=>{ seconds++; btn.textContent = `å½•éŸ³ä¸­ ${seconds}s â¹`; },1000);
      recorder.onstop = ()=>{
        clearInterval(recordInterval);
        const blob = new Blob(audioChunks,{type:'audio/webm'});
        audioChunks=[];
        const reader = new FileReader();
        reader.onloadend = ()=>{
          const base64Audio = reader.result.split(',')[1];
          roomRef.push({
            name: name,
            text: null,
            imageUrl: null,
            audioUrl: base64Audio || null,
            timestamp: Date.now()
          });
        };
        reader.readAsDataURL(blob);
        btn.textContent = "ğŸ¤ å¼€å§‹å½•éŸ³";
        btn.classList.remove("recording");
        isRecording=false;
      };
      recorder.start();
      btn.classList.add("recording");
      isRecording=true;
    }catch(err){
      alert("æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼š"+err);
    }
  }else{
    recorder.stop();
  }
};

// ===== æ¸…ç©ºèŠå¤©è®°å½• =====
document.getElementById('clearBtn').onclick = ()=>{
  if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")){
    roomRef.remove();
    messagesDiv.innerHTML='';
    firstMessageKey = null;
  }
};
</script>
</body>
</html>
